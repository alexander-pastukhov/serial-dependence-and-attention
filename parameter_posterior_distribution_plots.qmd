---
title: "Experiment 3: Orientation with lower constrast"
format: html
---

## Libraries and settings required for analysis
```{r setup}
library(tidyverse)

library(cmdstanr)
library(fs)
library(ggtext)
library(glue)
library(kilter) # devtools:install_github("alexander-pastukhov/kilter", dependencies=TRUE)
library(loo)
library(patchwork)

source("utils.R")
```

##behavioral results
### per task
```{r}
plot_triptych1 <- function(t, exp, model){
  plots <- list()
  for (a_exp in exp){
    filename <- glue("ParameterPlots/{t}-posterior-prediction-{a_exp}-{model}.RDS")
    if (t == "abs"){
      if (a_exp == "exp01"){
        plots[[a_exp]] <- readRDS(filename)+ylim(2,86)}
      else{
        plots[[a_exp]] <- readRDS(filename)+ylim(25,65)}}
    else{
      if (a_exp == "exp01"){
        plots[[a_exp]] <- readRDS(filename)+xlim(-84,84)+ylim(-72,72)}
      else{
        plots[[a_exp]] <- readRDS(filename)+xlim(-40,40)+ylim(-35,35)}}
    }
  purrr::reduce(plots, `|`) + plot_layout(axis_titles = "collect", guides = 'collect')
  ggsave(glue("Figures/{t}-{model}.png"), units = "cm", width = 40, height = 13)
  ggsave(glue("Figures/{t}-{model}.svg"), units = "cm", width = 40, height = 13)
}
experiments <- c("exp01", "exp02", "exp03")
plot_triptych1("abs", experiments, "ubi_re_cte")
plot_triptych1("rel", experiments, "ubi_re_cte")
#plot_triptych1("abs", "exp01", "log_linear")

```


## Plot triptych for each parameter (per experiment)
```{r}
plot_triptych <- function(exp, parameter_name){
  plots <- list()
  for (a_exp in exp){
    filename <- glue("ParameterPlots/posterior-distribution-{a_exp}-{parameter_name}.RDS")
    plots[[a_exp]] <- readRDS(filename)#+xlim(0,80)
  }
  purrr::reduce(plots, `+`) +
  #geom_vline(xintercept = 0, linetype = "longdash", linewidth = 0.7) + 
    plot_layout(guides = 'collect', axis_titles = "collect")
}

experiments <- c("exp01", "exp02", "exp03")

plot_triptych(experiments, "Maximal Response Weight")
ggsave("Figures/w_max_r.png", units = "cm", width = 28, height = 7)
ggsave("Figures/w_max_r.svg", units = "cm", width = 28, height = 7)

plot_triptych(experiments, "Maximal Evidence Weight")
ggsave("Figures/w_max_e.png", units = "cm", width = 28, height = 7)
ggsave("Figures/w_max_e.svg", units = "cm", width = 28, height = 7)

plot_triptych(experiments, "Central Tendency Weight")
ggsave("Figures/w_ct.png", units = "cm", width = 28, height = 7)
ggsave("Figures/w_ct.svg", units = "cm", width = 28, height = 7)

plot_triptych(experiments, "Prior Relevance")
ggsave("Figures/lambda.png", units = "cm", width = 28, height = 7)
ggsave("Figures/lambda.svg", units = "cm", width = 28, height = 7)

#plot_triptych(experiments, "Beta Central Tendency")
#ggsave("Figures/b_ct.png", units = "cm", width = 28, height = 7)
#ggsave("Figures/b_ct.svg", units = "cm", width = 28, height = 7)

# Sigma
((readRDS("ParameterPlots/posterior-distribution-exp01-Sigma Max.RDS"))|
  readRDS("ParameterPlots/posterior-distribution-exp02-Sigma.RDS")| readRDS("ParameterPlots/posterior-distribution-exp03-Sigma.RDS")) + plot_layout(guides = 'collect', axis_titles = "collect")
ggsave("Figures/sigma.png", units = "cm", width = 28, height = 7)
ggsave("Figures/sigma.svg", units = "cm", width = 28, height = 7)
```


```{r}
# weights
w01 <- readRDS("Weights/weights01.RDS") |>
  mutate(exp = "Exp.1: Numerosity")
w02 <- readRDS("Weights/weights02.RDS") |>
  mutate(exp = "Exp.2: Orientation (high contrast)")
w03 <- readRDS("Weights/weights03.RDS") |>
  mutate(exp = "Exp.3: Orientation (low contrast)")

weights <- 
  bind_rows(w01, w02, w03) |>
  mutate(exp = factor(exp)) |>
  mutate(Parameter = fct_drop(Parameter))

ggplot(weights, aes(x = Task, y = mu, color = Task, fill = Task)) +
  geom_boxplot(show.legend = FALSE, outlier.shape = NA, alpha = 0.5) +
  # ggforce::geom_sina(show.legend = FALSE, alpha = 0.05) +
  scale_fill_manual(values = c("single" = "#eb6972ff", "dual" = "#336a97ff"))+
  scale_color_manual(values = c("single" = "#eb6972ff", "dual" = "#336a97ff"))+
  geom_hline(yintercept = 0, linetype = "dashed") +
  #facet_wrap(. ~ Parameter) +
  scale_y_continuous(name = "Weight") +#, limits = c(-0.25, 1)) 
  facet_grid(exp ~ Parameter)

ggsave("Figures/weights.png", units = "cm", width = 17, height = 17)
ggsave("Figures/weights.svg", units = "cm", width = 17, height = 17)
```

```{r}
att_diff <-
  weights |>
  pivot_wider(names_from = Task, values_from = mu) |>
  mutate(AttDiff = dual - single) |>
  group_by(Parameter, exp) |>
  summarise(P = ifelse(median(AttDiff) > 0, mean(AttDiff>0), mean(AttDiff<0)),
            Info = sprintf("%.2f<br/>%.2f,%.2f<br/>%.1f%%", mean(AttDiff), kilter::lower_ci(AttDiff), kilter::upper_ci(AttDiff), 100 * P),
            .groups = "drop") |>
  mutate(X = 3 * ( as.integer(exp) - 1) + 1.5,
         Y = ifelse(Parameter == "We", 0.6, -0.6))

att_labels <-
  tibble(X = 4.5,
         Y = c(-0.35, 0.85, -0.35),
         Parameter = factor(levels(att_diff$Parameter), levels = levels(att_diff$Parameter)),
         Label = "<span style='color:#336a97ff;font-weight: bolder;'>W<sub>dual</sub></span> - <span style='color:#eb6972ff;font-weight: bolder;'>W<sub>single</sub></span>",
         Xmin = 0, Xmax = 9,
         YminU = c(-0.45, 0.75, -0.45), YmaxU = c(-0.25, 0.95, -0.25),
         Ymin = c(-0.75, 0.45, -0.75), Ymax = c(-0.25, 0.95, -0.25))

weights |>
  mutate(X =  3 * ( as.integer(exp) - 1) + as.integer(Task),
         Condition = factor(glue("{exp}-{Task}"))) |>

ggplot(aes(x = X, y = mu)) +
  geom_hline(yintercept = c(0, 1), linetype = "dashed") +
  geom_rect(data = att_labels, aes(y = Y, xmin = Xmin, xmax = Xmax, ymin = Ymin, ymax = Ymax), fill = "gray", color = NA) +
  geom_rect(data = att_labels, aes(y = Y, xmin = Xmin, xmax = Xmax, ymin = YminU, ymax = YmaxU), fill = "#FEFEFE", color = NA) +
  geom_richtext(data = att_labels, aes(label = Label, x = X, y = Y), label.colour = NA, fill = NA) +
  geom_richtext(data = att_diff, aes(label = Info, y = Y), size = 2.5, label.colour = NA, fill = NA) +
  geom_boxplot(aes(group = Condition, color = Task, fill = Task), alpha = 0.5, outlier.shape = NA) +
  # ggforce::geom_sina(show.legend = FALSE, alpha = 0.01) +
  facet_wrap(. ~ Parameter, labeller = labeller(Parameter = c("Wr" = "Prior Response", "We" = "Prior Evidence", "Wct" = "Average Evidence"))) +
  scale_x_continuous(name = "Experiment", breaks = c(1.5, 4.5, 7.5), labels = 1:3, limits = c(0, 9), expand = c(0, 0)) +
  scale_y_continuous(name = "Repulsive ← Weight → Attractive", limits = c(-1, 1),
                     sec.axis = dup_axis(name = NULL, breaks = c(-0.52, -0.6, -0.68, 0.68, 0.6, 0.52), labels = rep(c("Mean", "97% CI", "Pr"), 2))) +
    scale_fill_manual(values = c("single" = "#eb6972ff", "dual" = "#336a97ff"))+
  scale_color_manual(values = c("single" = "#eb6972ff", "dual" = "#336a97ff")) +
  theme(legend.position = "bottom", axis.ticks.y.right = element_blank(), axis.text.y.right = element_text(size = 8))

ggsave("Figures/all-weights.png", units = "cm", width = 16, height = 12)
ggsave("Figures/all-weights.svg", units = "cm", width = 16, height = 12)
```

